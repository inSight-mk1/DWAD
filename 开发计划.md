# DWAD系统开发计划

## 0. 当前完成状态（更新日期：2025-10-13）

### 已完成功能

#### ✅ 数据下载模块
- **脚本位置**: `scripts/download_data.py`
- **核心模块**: `dwad/data_fetcher/goldminer_fetcher.py`, `dwad/data_storage/parquet_storage.py`
- **功能说明**:
  - 支持从掘金API获取所有A股股票的历史行情数据
  - 实现断点续传功能，避免重复下载
  - 数据存储格式：Parquet（位于 `data/stocks/` 目录）
  - 支持增量更新，自动补充最新交易日数据
  - 已保存股票基本信息（股票代码、名称、市场等）

#### ✅ 股池指数计算模块
- **脚本位置**: `scripts/calculate_index.py`
- **核心模块**: `dwad/analysis/index_calculator.py`
- **功能说明**:
  - 从 `config/stock_pools.yaml` 或 `config/stock_pools_example.yaml` 加载股池配置
  - 自动将股票中文名称映射为掘金API代码格式
  - **平均指数计算**：计算股池内所有成分股的平均价格指数，基点为1000
  - 指数数据存储：Parquet格式，位于 `data/indices/{股池名称}/` 目录
  - 文件命名：`{概念名称}_average.parquet`
  - 每日记录参与计算的股票数量（`stocks_count` 字段）

**异常情况处理**:
1. ✅ **除权除息**：使用前复权数据（`ADJUST_PREV`），历史价格已自动修正
2. ✅ **停牌**：采用前向填充，停牌日价格等于最后交易日价格
3. ✅ **上市晚于指数起始日**：直接排除该股票，不参与指数计算（固定成分股法）
4. ✅ **数据缺失检测**：自动检查缺失率，超过50%给出警告
5. ✅ **成分股数量追踪**：记录每日参与计算的股票数量，便于分析指数稳定性
6. ✅ **排除股票预警**：上市晚的股票会在日志中明确标注并给出警告

#### ✅ 指数比较和排名模块
- **脚本位置**: `scripts/compare_indices.py`
- **核心模块**: `dwad/analysis/index_comparator.py`, `dwad/visualization/ranking_visualizer.py`
- **配置文件**: `config/index_comparison.yaml`
- **功能说明**:
  - 从比较配置文件加载需要对比的多个股池指数
  - **数据归一化**：从配置的比较起点归一化所有指数到100基点
  - **排名计算**：计算每个交易日基于涨跌幅的排名（涨幅最大排名第1）
  - **异常处理**：自动处理不同指数起始日期不同的情况
  - **可视化生成**：生成交互式Web页面展示排名趋势
  - **数据导出**：支持导出排名数据到CSV文件

**核心特性**:
1. ✅ **灵活配置**：通过YAML配置文件指定需要比较的指数
2. ✅ **智能对齐**：自动对齐不同指数的交易日序列，处理数据缺失
3. ✅ **排名追踪**：实时追踪每个指数在每个交易日的排名变化
4. ✅ **可视化展示**：使用Plotly生成美观的排名趋势图
5. ✅ **性能统计**：显示最新排名和涨跌幅统计

**输出文件**:
- `reports/index_ranking_comparison.html`: 排名趋势可视化页面
- `reports/index_ranking_data.csv`: 详细排名数据CSV文件

### 功能限制和待完善项

#### ⚠️ 市值加权指数（暂未实现）
- **原因**: 当前数据下载模块未包含市值数据
- **影响**: 无法计算市值加权指数，只能计算平均价格指数
- **解决方案**:
  1. 修改 `dwad/data_fetcher/goldminer_fetcher.py` 中的 `get_historical_data` 方法
  2. 在 `required_columns` 列表中添加 `market_cap` 字段（如果API返回）
  3. 更新配置文件 `config/config.yaml`，在 `data_fetcher.market_data_fields` 中添加市值相关字段
  4. 重新下载数据或增量补充市值数据
  5. 在 `index_calculator.py` 中实现 `calculate_market_cap_weighted_index` 方法

#### 使用指南

#### 1. 数据下载
```bash
cd scripts
python download_data.py
```

#### 2. 指数计算
```bash
cd scripts
python calculate_index.py
```

**配置说明**：
- 在 `config/config.yaml` 中可以设置：
  - `index_calculator.base_value`: 指数基准值（默认1000.0）
  - `index_calculator.start_date`: 指数起始日期（默认null，即使用最早日期）
  
**示例配置**：
```yaml
index_calculator:
  base_value: 1000.0
  start_date: "2020-01-01"  # 从2020年开始计算指数
```

#### 3. 指数比较和排名
```bash
cd scripts
python compare_indices.py
```

**配置说明**：
- 在 `config/index_comparison.yaml` 中配置：
  - `comparison_start_date`: 比较起始日期（用于归一化）
  - `indices_to_compare`: 需要比较的指数列表
  - `visualization`: 可视化图表配置（标题、尺寸、样式等）

**示例配置**：
```yaml
comparison_start_date: "2024-09-18"

indices_to_compare:
  - pool_name: "大概念股池"
    concept_name: "机器人概念"
    display_name: "机器人"
  - pool_name: "大概念股池"
    concept_name: "AI概念"
    display_name: "AI"

visualization:
  title: "股池指数排名趋势"
  width: 1400
  height: 800
```

**输出**：
- `reports/index_ranking_comparison.html`: 可在浏览器中查看排名趋势
- `reports/index_ranking_data.csv`: 详细排名数据

### 数据存储结构
```
data/
├── stocks/           # 股票行情数据
│   ├── SHSE_600000.parquet
│   ├── SZSE_000001.parquet
│   └── ...
├── indices/          # 指数数据
│   ├── 大概念股池/
│   │   ├── 机器人概念_average.parquet
│   │   ├── 电池概念_average.parquet
│   │   └── ...
│   └── 重点关注股池/
│       └── ...
└── metadata/         # 元数据
    ├── stock_info.parquet
    └── update_log.json

reports/              # 分析报告和可视化
├── index_ranking_comparison.html  # 排名趋势可视化
├── index_ranking_data.csv         # 排名数据CSV
└── ...
```

---

## 1. 项目开发阶段

### 阶段一：基础设施搭建 (1-2周)

#### 1.1 项目环境搭建
- [x] 创建项目目录结构
- [x] 配置Python虚拟环境
- [x] 安装基础依赖包
- [x] 设置代码规范和格式化工具
- [x] 初始化Git仓库

#### 1.2 核心框架搭建
- [x] 设计配置管理模块
- [x] 实现日志系统
- [ ] 创建基础异常处理类
- [ ] 搭建单元测试框架

#### 1.3 数据存储方案确定
- [x] 评估Parquet vs SQLite性能
- [x] 实现数据存储抽象接口
- [x] 创建数据存储实现类
- [x] 设计数据库表结构或文件结构

### 阶段二：数据获取模块 (2-3周)

#### 2.1 掘金API集成
- [ ] 研究掘金API文档
- [ ] 实现API认证和连接
- [ ] 设计API调用频率限制
- [ ] 实现错误重试机制

#### 2.2 数据获取功能
- [x] 实现股票信息查询
- [x] 实现历史行情数据获取
- [ ] 实现实时数据获取
- [x] 数据格式标准化处理

#### 2.3 数据验证和清洗
- [x] 实现数据完整性检查（指数计算时检查缺失率）
- [x] 处理停牌、除权除息等特殊情况（前复权+前向填充）
- [x] 数据异常值检测和处理（上市日期校验、缺失率预警）
- [ ] 创建数据质量报告

### 阶段三：股池管理和指数计算 (2-3周)

#### 3.1 股池管理模块
- [x] 设计股池配置文件格式
- [x] 实现股池加载和验证
- [x] 股票代码映射和查询
- [ ] 股池编辑和管理界面

#### 3.2 指数计算引擎
- [ ] 实现市值加权指数计算（待补充市值数据）
- [x] 实现平均股价指数计算
- [x] 指数基期设定和归一化
- [x] 指数数据存储和查询

#### 3.3 批量数据处理
- [ ] 实现初始建库功能
- [ ] 设计增量更新机制
- [ ] 批量指数计算优化
- [ ] 数据处理进度显示

### 阶段四：分析和可视化模块 (2-3周)

#### 4.1 概念强弱分析
- [x] 实现同类概念对比分析（指数比较模块）
- [x] 实现跨类概念对比分析（支持跨股池比较）
- [x] 计算性能指标(收益率、涨跌幅等)
- [x] 概念排名和评分功能（基于涨跌幅的每日排名）
- [ ] 计算高级指标(波动率、夏普比率等)

#### 4.2 可视化图表
- [x] 实现指数排名趋势对比图（交互式Web页面）
- [x] 图表交互功能（使用Plotly）
- [x] 图表导出功能（PNG格式）
- [ ] 实现概念强弱热力图
- [ ] 实现更多性能统计图表

#### 4.3 报告生成
- [x] 实现HTML格式可视化报告
- [x] 实现CSV格式数据导出
- [ ] 设计完整的分析报告模板
- [ ] 支持PDF等更多输出格式
- [ ] 报告定制化配置

### 阶段五：用户界面和集成 (2周)

#### 5.1 命令行界面
- [ ] 设计CLI命令结构
- [ ] 实现数据更新命令
- [ ] 实现分析查询命令
- [ ] 添加帮助和文档

#### 5.2 Web界面 (可选)
- [ ] 使用Streamlit搭建Web界面
- [ ] 实现股池配置界面
- [ ] 实现分析查询界面
- [ ] 实现图表展示界面

#### 5.3 系统集成测试
- [ ] 端到端功能测试
- [ ] 性能压力测试
- [ ] 用户体验测试
- [ ] 文档完善

### 阶段六：优化和部署 (1周)

#### 6.1 性能优化
- [ ] 数据读取性能优化
- [ ] 计算算法优化
- [ ] 内存使用优化
- [ ] 并发处理优化

#### 6.2 部署和发布
- [ ] 创建部署脚本
- [ ] 配置自动化任务
- [ ] 用户手册编写
- [ ] 版本发布

## 2. 技术选型详细说明

### 2.1 编程语言和框架
```python
# 核心技术栈
Python 3.8+          # 主要编程语言
pandas 1.5.0+        # 数据处理和分析
numpy 1.21.0+        # 数值计算
pyarrow 10.0.0+      # Parquet文件处理
```

### 2.2 数据存储技术

#### 推荐方案：Parquet + JSON配置
```python
# 数据存储
pyarrow              # Parquet文件读写
fastparquet          # 备用Parquet库
pyyaml               # YAML配置文件
```

**选择理由**：
- **性能优势**：Parquet格式压缩率高，读取速度快
- **简单维护**：无需数据库安装和维护
- **扩展性好**：支持分布式存储和处理
- **兼容性强**：多种工具支持Parquet格式

#### 备选方案：SQLite数据库
```python
# 数据库方案
sqlite3              # Python内置SQLite支持
sqlalchemy           # ORM框架
alembic              # 数据库迁移工具
```

### 2.3 数据可视化
```python
# 可视化库
plotly 5.0.0+        # 交互式图表(推荐)
matplotlib 3.5.0+    # 基础图表
seaborn 0.11.0+      # 统计图表
bokeh 2.4.0+         # Web交互图表(备选)
```

### 2.4 Web界面技术
```python
# Web框架选择
streamlit 1.20.0+    # 快速原型(推荐)
fastapi 0.95.0+      # API后端(高级)
dash 2.8.0+          # 仪表板(备选)
```

### 2.5 任务调度和工具
```python
# 辅助工具
apscheduler 3.9.0+   # 任务调度
loguru 0.6.0+        # 日志处理
click 8.0.0+         # CLI命令行
tqdm 4.64.0+         # 进度条
requests 2.28.0+     # HTTP请求
```

## 3. 开发环境配置

### 3.1 项目依赖文件

#### requirements.txt
```txt
# 核心数据处理
pandas>=1.5.0
numpy>=1.21.0
pyarrow>=10.0.0

# API和网络
requests>=2.28.0
urllib3>=1.26.0

# 可视化
plotly>=5.0.0
matplotlib>=3.5.0
seaborn>=0.11.0

# Web界面
streamlit>=1.20.0

# 配置和工具
pyyaml>=6.0
loguru>=0.6.0
click>=8.0.0
tqdm>=4.64.0
apscheduler>=3.9.0

# 开发工具
pytest>=7.0.0
black>=22.0.0
flake8>=4.0.0
mypy>=0.991
```

#### requirements-dev.txt
```txt
# 开发依赖
jupyter>=1.0.0
ipykernel>=6.0.0
notebook>=6.4.0

# 代码质量
black>=22.0.0
isort>=5.10.0
flake8>=4.0.0
mypy>=0.991
pre-commit>=2.17.0

# 测试工具
pytest>=7.0.0
pytest-cov>=4.0.0
pytest-mock>=3.7.0

# 文档生成
sphinx>=4.5.0
sphinx-rtd-theme>=1.0.0
```

### 3.2 开发工具配置

#### .gitignore
```gitignore
# Python
__pycache__/
*.py[cod]
*.so
.Python
env/
venv/
.venv/

# 数据文件
data/
*.parquet
*.db
*.sqlite

# 配置文件
config/api_keys.yaml
.env

# IDE
.vscode/
.idea/
*.swp
*.swo

# 日志和缓存
logs/
.cache/
.pytest_cache/

# 系统文件
.DS_Store
Thumbs.db
```

#### pyproject.toml
```toml
[tool.black]
line-length = 88
target-version = ['py38']
include = '\.pyi?$'

[tool.isort]
profile = "black"
multi_line_output = 3

[tool.mypy]
python_version = "3.8"
warn_return_any = true
warn_unused_configs = true
disallow_untyped_defs = true

[tool.pytest.ini_options]
testpaths = ["tests"]
python_files = "test_*.py"
python_classes = "Test*"
python_functions = "test_*"
```

## 4. 项目里程碑

### 里程碑1：MVP版本 (4-5周) ✅ 已完成
- [x] 完成基础设施搭建
- [x] 实现数据获取和存储
- [x] 完成指数计算功能（平均指数）
- [x] 实现指数比较和排名分析
- [x] 实现基础可视化功能（排名趋势图）

**完成日期**: 2025-10-13

### 里程碑2：功能完整版 (7-8周)
- [x] 完成基础分析功能（指数比较、排名）
- [x] 实现Web可视化页面（排名趋势）
- [ ] 实现更多分析功能（波动率、相关性等）
- [ ] 实现更多可视化图表（热力图、箱线图等）
- [ ] 完善用户文档
- [ ] 基础CLI界面

### 里程碑3：优化版本 (9-10周)
- [ ] 性能优化完成
- [ ] 自动化部署
- [ ] 完整测试覆盖
- [ ] 生产就绪

## 5. 风险管理

### 5.1 技术风险
- **API限制**：掘金平台API调用频率限制
  - 缓解措施：实现智能调用频率控制
- **数据质量**：数据缺失或异常
  - 缓解措施：完善数据验证和清洗机制
- **性能问题**：大量数据处理性能瓶颈
  - 缓解措施：分阶段优化，使用并行处理

### 5.2 进度风险
- **依赖延迟**：外部API或数据源问题
  - 缓解措施：设计模拟数据进行开发测试
- **需求变更**：功能需求调整
  - 缓解措施：模块化设计，保持扩展性

## 6. 后续发展规划

### 6.1 功能扩展
- 集成更多数据源
- 增加机器学习预测模型
- 支持更多技术指标
- 移动端应用开发

### 6.2 技术升级
- 微服务架构改造
- 云端部署支持
- 实时数据流处理
- 分布式计算支持