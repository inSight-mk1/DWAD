# DWAD 实时价格功能使用说明

## 功能概述

DWAD 系统现已支持实时价格查询功能，可以在盘中获取股票的实时价格，并在指数比较图表中实时显示排名变化。

## 主要特性

1. **实时价格获取**：通过掘金API获取股票的当前最新价
2. **实时指数计算**：基于实时价格计算股池指数的当前涨跌幅
3. **实时排名显示**：在可视化图表中用虚线显示实时排名
4. **时间戳显示**：显示实时价格的获取时间（以所有股票中最早的时间为准）

## 核心组件

### 1. RealtimePriceFetcher (实时价格获取器)

位置：`src/dwad/data_fetcher/realtime_price_fetcher.py`

**功能**：
- 获取单只或多只股票的实时价格
- 计算相对于基准价格的涨跌幅
- 获取股池中所有股票的实时价格及最早时间戳

**主要方法**：

```python
from dwad.data_fetcher.realtime_price_fetcher import RealtimePriceFetcher

# 初始化
fetcher = RealtimePriceFetcher()

# 获取单只股票实时价格
price_info = fetcher.get_current_price("SHSE.600000")
print(f"价格: {price_info.price}, 时间: {price_info.created_at}")

# 批量获取多只股票实时价格
symbols = ["SHSE.600000", "SZSE.000001", "SHSE.600036"]
prices = fetcher.get_current_prices(symbols)

# 获取股池实时价格（含最早时间戳）
pool_prices, earliest_time = fetcher.get_pool_current_prices(symbols)
print(f"最早价格时间: {earliest_time}")

# 计算涨跌幅
base_prices = {"SHSE.600000": 10.50, "SZSE.000001": 15.20}
changes = fetcher.calculate_realtime_change(symbols, base_prices)
```

### 2. IndexComparator (指数比较器) - 实时功能增强

位置：`src/dwad/analysis/index_comparator.py`

**新增功能**：
- 支持实时价格查询
- 计算实时指数排名
- 将实时数据整合到可视化数据结构中

**使用方法**：

```python
from dwad.analysis.index_comparator import IndexComparator

# 初始化时启用实时价格功能
comparator = IndexComparator(enable_realtime=True)

# 加载指数数据
comparator.load_indices_data()

# 计算历史排名
comparator.calculate_rankings()

# 获取实时排名
realtime_ranking = comparator.get_realtime_ranking()

if realtime_ranking:
    rankings = realtime_ranking['rankings']
    timestamp = realtime_ranking['timestamp']
    
    print(f"实时排名 (时间: {timestamp}):")
    for name, data in sorted(rankings.items(), key=lambda x: x[1]['rank']):
        print(f"  {data['rank']}. {name}: {data['change_pct']:+.2f}%")
```

### 3. RankingVisualizer (排名可视化器) - 实时显示支持

位置：`src/dwad/visualization/ranking_visualizer.py`

**新增功能**：
- 在图表中用虚线显示实时数据
- 在实时数据点上显示标记
- 在图表上显示实时价格获取时间

**图表特性**：
- 历史数据：实线
- 实时数据：虚线 + 圆点标记
- 时间显示：在信息面板中显示"实时数据时间"

## 使用指南

### 快速开始

1. **运行实时比较脚本**：

```bash
cd d:/projects/DWAD
python scripts/compare_indices_realtime.py
```

2. **查看输出**：
   - 打开 `reports/index_ranking_comparison_realtime.html`
   - 实线部分为历史数据
   - 虚线部分为实时数据
   - 查看"实时数据时间"了解数据获取时间

### 示例脚本

#### 1. 基础实时价格获取示例

```bash
python examples/realtime_price_example.py
```

演示内容：
- 单只股票实时价格查询
- 批量股票实时价格查询
- 股池实时价格获取
- 涨跌幅计算
- DataFrame格式转换

#### 2. 实时指数比较示例（单周期）

```bash
python scripts/compare_indices_realtime.py
```

功能：
- 加载历史指数数据
- 计算历史排名
- 获取实时价格
- 计算实时排名
- 生成包含实时数据的可视化图表

#### 3. 多周期实时指数比较示例

```bash
python scripts/compare_indices_multi_period_realtime.py
```

功能：
- 加载历史指数数据
- 计算多个周期（20、55、233个交易日）的历史排名
- 获取实时价格
- 计算实时排名
- 在一个HTML页面生成3个图表，每个图表显示不同周期的排名趋势
- 每个图表都包含历史数据（实线）和实时数据（虚线）

输出：
- `reports/index_ranking_multi_period_realtime.html`

## 配置要求

### 1. 掘金API Token

在 `config.yaml` 中配置掘金API token：

```yaml
goldminer:
  token: "your_goldminer_token_here"
```

### 2. 股池配置

确保 `config/stock_pools.yaml` 文件存在并正确配置股池：

```yaml
stock_pools:
  大概念股池:
    机器人概念:
      - "埃斯顿"
      - "拓斯达"
      - "汇川技术"
    # ... 更多股票
```

### 3. 指数比较配置

在 `config/index_comparison.yaml` 中配置需要比较的指数：

```yaml
comparison_start_date: "2024-01-01"

indices_to_compare:
  - pool_name: "大概念股池"
    concept_name: "机器人概念"
    display_name: "机器人"
  # ... 更多指数
```

## 技术细节

### 实时价格计算逻辑

1. **获取昨日收盘价**：从历史数据中获取最后一个交易日的收盘价
2. **获取实时价格**：通过掘金API的 `current_price()` 函数获取当前最新价
3. **计算涨跌幅**：`涨跌幅 = (实时价格 / 昨日收盘价 - 1) * 100`
4. **计算指数值**：对股池中所有股票的涨跌幅求平均
5. **计算排名**：根据涨跌幅对所有指数进行排名

### 时间戳处理

- 掘金API返回的 `created_at` 字段包含价格的创建时间
- 系统取所有股票中最早的时间作为实时数据的时间戳
- 这个时间戳会显示在图表的信息面板中

### 图表渲染逻辑

1. **历史数据**：
   - 使用实线绘制
   - x轴为交易日索引（0, 1, 2, ...）
   - y轴为排名

2. **实时数据**：
   - 从最后历史点到实时点绘制虚线
   - 在实时点上添加圆点标记
   - x轴索引为历史数据长度 + 1
   - 不在图例中显示（避免重复）

## 注意事项

1. **交易时间限制**：实时价格功能仅在交易时间内有效
2. **API访问限制**：请注意掘金API的调用频率限制
3. **数据延迟**：实时价格可能有几秒到几分钟的延迟
4. **网络要求**：需要稳定的网络连接才能获取实时价格
5. **历史数据依赖**：需要先运行历史数据下载和指数计算脚本

## 故障排除

### 问题1：无法获取实时价格

**可能原因**：
- 掘金API token未配置或无效
- 不在交易时间内
- 网络连接问题

**解决方法**：
- 检查 `config.yaml` 中的token配置
- 确认当前是交易时间
- 检查网络连接

### 问题2：股池配置文件未找到

**错误信息**：`股池配置文件不存在`

**解决方法**：
- 确保 `config/stock_pools.yaml` 文件存在
- 参考 `config/stock_pools_example.yaml` 创建配置文件

### 问题3：未找到股票代码

**可能原因**：
- 股票基本信息未下载
- 股票名称拼写错误

**解决方法**：
- 运行 `python scripts/download_stock_data.py` 下载股票信息
- 检查股池配置中的股票名称拼写

## API参考

### RealtimePrice 数据类

```python
@dataclass
class RealtimePrice:
    symbol: str          # 股票代码
    price: float         # 最新价
    created_at: datetime # 创建时间
```

### 掘金API current_price 函数

```python
from gm.api import current_price

# 获取实时价格
data = current_price(symbols=['SHSE.600000', 'SZSE.000001'])

# 返回格式
[
    {
        'symbol': 'SHSE.600000',
        'price': 10.55,
        'created_at': datetime(2025, 10, 15, 14, 30, 0)
    },
    ...
]
```

## 更新日志

### 2025-10-15
- ✅ 新增 `RealtimePriceFetcher` 实时价格获取器
- ✅ `IndexComparator` 支持实时排名计算（单周期和多周期）
- ✅ `RankingVisualizer` 支持虚线显示实时数据（单图表和多图表）
- ✅ 新增 `compare_indices_realtime.py` 脚本（单周期实时比较）
- ✅ 新增 `compare_indices_multi_period_realtime.py` 脚本（多周期实时比较）
- ✅ 新增 `realtime_price_example.py` 示例
- ✅ 多周期图表支持实时数据显示

## 相关文档

- [指数比较使用说明](./指数比较使用说明.md)
- [掘金API知识文档](../掘金API知识文档.md)
- [系统架构设计](../系统架构设计.md)
