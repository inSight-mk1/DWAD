# 股池配置检查与自动修复使用说明

本文档介绍脚本 `scripts/check_stock_pools.py` 的功能、用法与最佳实践，用于检查并修复 `config/stock_pools.yaml` 中的成分股名称，确保历史数据下载与实时数据获取路径的一致性。

## 功能概述

- **双路径一致性检查**：
  - 历史下载路径（Exact）：严格等值匹配名称 → 代码。
  - 实时路径（Contains）：名称包含匹配 → 代码。
- **智能匹配建议（Smart）**：
  - 名称规范化（去前缀/后缀、空格、全角转半角）+ 模糊匹配，给出官方简称与代码建议。
- **仅中文模糊匹配（双边都找不到时）**：
  - 自动保留中文字符进行二次模糊匹配；仍找不到则从配置删除该条目。
- **自动修复配置（可选）**：
  - 单边找不到：按建议或已匹配代码反查官方简称替换。
  - 双边都找不到：中文模糊成功则替换，否则删除。
  - 生成备份与修复明细。
- **可选实时探测（需要 gm3 与 goldminer.token）**：
  - 批量探测 `rt_contains_symbol` 是否可实时获取，标注 `realtime_fetchable`。

## 依赖与前置

- 配置文件：`config/stock_pools.yaml`
- 本地股票基础信息与历史数据：通过项目已有流程生成（`ParquetStorage`）。
- 可选：实时探测
  - 安装 `gm3`
  - 在 `config/config.yaml` 配置 `goldminer.token`

## 常见命名问题（脚本会自动处理）

- 交易日前缀/后缀：`XD/DR/XR/R`、`*ST/ST/S*ST`、`-U/-W`
- 全角字母/数字：如 `Ａ` → `A`
- 冗余空格/符号：如 `怡 亚 通` → `怡亚通`
- 旧简称或别名：按本地基础库“官方简称”替换

## 命令行参数

脚本路径：`scripts/check_stock_pools.py`

- `-c, --config` 指定股池配置路径（默认：`config/stock_pools.yaml`）
- `-o, --output` 检查结果输出（默认：`reports/stock_pools_check.csv`，支持 `.json`）
- `--format` 输出格式：`csv` 或 `json`（默认根据后缀推断）
- `-r, --realtime` 启用实时可获取性检查（需 gm3 与 token）
- `--batch-size` 实时批大小（默认 200）
- `--fuzzy-threshold` 智能匹配阈值（默认 0.80）
- `--show-only-issues` 控制台仅展示有问题的条目（完整结果写入输出文件）
- `--apply-fixes` 按规则自动修复并更新配置文件（见下方修复策略）
- `--output-config` 修复后的配置输出路径（默认覆盖原文件）
- `--no-backup` 覆盖原文件时不生成备份（默认会生成 `.bak-YYYYmmdd-HHMMSS`）

## 修复策略详情（启用 `--apply-fixes`）

- **单边找不到（Exact 与 Contains 不一致）**：
  - 优先使用智能建议 `smart_matched_db_name`。
  - 若无建议，则使用已匹配到的 `symbol` 回查官方简称替换（优先 `rt_contains_symbol`，其次 `db_exact_symbol`）。
- **双边都找不到**：
  - 自动提取仅中文进行二次模糊匹配，若成功则替换。
  - 仍找不到则删除该条目。
- **去重与顺序**：同一概念下自动去重，保留遍历顺序。
- **备份与明细**：覆盖原文件前自动备份；生成修复明细 CSV。

## 使用示例

- 仅做检查（不改配置）、输出问题到控制台：
```bash
python scripts/check_stock_pools.py --show-only-issues
```

- 启用实时探测（需要 gm3 与 token）：
```bash
python scripts/check_stock_pools.py -r --show-only-issues
```

- 自动修复并覆盖原配置（默认会生成备份）：
```bash
python scripts/check_stock_pools.py --apply-fixes --show-only-issues
```

- 自动修复并输出到新文件（不覆盖原文件）：
```bash
python scripts/check_stock_pools.py --apply-fixes \
  --output-config config/stock_pools_fixed.yaml \
  --show-only-issues
```

- 调整模糊阈值与实时批大小：
```bash
python scripts/check_stock_pools.py -r --fuzzy-threshold 0.78 --batch-size 300
```

## 输出文件

- **检查结果**：`reports/stock_pools_check.csv`（或 `.json`）
  - 关键字段：
    - `db_exact_symbol`、`rt_contains_symbol`、`smart_symbol`
    - `hist_data_exact`、`hist_data_rt_symbol`、`realtime_fetchable`
    - `notes`（问题说明与建议）
  - 说明：未启用或无法运行实时探测时，`realtime_fetchable` 为 `None`。

- **修复后的配置**：
  - 覆盖原文件：`config/stock_pools.yaml`（自动生成 `.bak-YYYYmmdd-HHMMSS` 备份）
  - 输出新文件：`--output-config <path>` 指定的 YAML

- **修复明细**：`reports/stock_pools_fixes.csv`
  - 字段示例：`pool/concept/old_name/new_name/action/source/symbol`
  - `action`：`changed` 或 `removed`
  - `source`：`smart`、`by_symbol_rt`、`by_symbol_exact`、`chinese_only`、`unmatched_both`

## 推荐工作流

1. **初次检查**（不启用实时）：
   - 运行：`python scripts/check_stock_pools.py --show-only-issues`
   - 打开：`reports/stock_pools_check.csv`，确认问题条目与建议。
2. **应用修复**：
   - 推荐先输出到新文件审阅：
     - `python scripts/check_stock_pools.py --apply-fixes --output-config config/stock_pools_fixed.yaml --show-only-issues`
   - 审阅无误后，可直接覆盖原配置（有备份）：
     - `python scripts/check_stock_pools.py --apply-fixes --show-only-issues`
3. **验证**：
   - 重新运行历史指数计算与实时排名脚本，确认“未找到代码”的告警显著减少。

## 故障排查

- `realtime_fetchable` 全为 `None`：
  - 未安装 `gm3` 或未配置 `goldminer.token`，不影响修复逻辑，仅表示未做实时探测。
- 仍有“未找到代码”告警：
  - 检查该名称是否使用了最新“官方简称”；手动对照 `stock_info` 基础表。
  - 适当降低 `--fuzzy-threshold` 重试。
- 恢复到修复前：
  - 使用生成的 `.bak-YYYYmmdd-HHMMSS` 备份文件覆盖回去。

## 相关文件路径

- 脚本：`scripts/check_stock_pools.py`
- 配置：`config/stock_pools.yaml`
- 报告目录：`reports/`

---
如需将修复自动集成到 CI/批处理流程，可在任务前先运行检查并应用修复，再执行指数计算与可视化脚本。
