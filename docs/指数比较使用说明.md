# 股池指数比较使用说明

## 📖 概述

股池指数比较模块用于对比分析多个股池指数的表现，计算每个交易日的排名，并生成可视化报告。

## 🎯 核心功能

### 1. 数据归一化
- 从配置的比较起点归一化所有指数到100基点
- 自动处理不同指数起始日期不同的情况
- 确保所有指数从同一起点进行比较

### 2. 排名计算
- 基于涨跌幅计算每个交易日的排名
- 涨幅最大的排名第1，涨幅最小的排名最后
- 自动追踪排名变化趋势

### 3. 可视化展示
- 生成交互式Web页面显示排名趋势
- 使用Plotly实现高质量图表
- 支持缩放、平移、导出等交互操作

### 4. 数据导出
- 导出详细排名数据到CSV文件
- 包含每日排名、归一化值、涨跌幅等信息

## 🚀 快速开始

### 前置条件

确保已完成以下步骤：

```bash
# 1. 下载股票数据
cd scripts
python download_data.py

# 2. 计算股池指数
python calculate_index.py
```

### 基本使用

```bash
# 3. 比较指数并生成可视化
cd scripts
python compare_indices.py
```

执行后会生成：
- `reports/index_ranking_comparison.html` - 排名趋势可视化页面
- `reports/index_ranking_data.csv` - 排名数据CSV文件

用浏览器打开HTML文件即可查看排名趋势图。

## ⚙️ 配置说明

### 配置文件位置

`config/index_comparison.yaml`

### 配置项详解

#### 1. 比较起始日期

```yaml
comparison_start_date: "2024-09-18"
```

- **作用**：所有指数从此日期开始归一化比较
- **可选值**：
  - 日期字符串（格式：`YYYY-MM-DD`）
  - `null`：使用所有指数中最晚的起始日期
- **建议**：设置为所有指数都有数据的日期

#### 2. 需要比较的指数

```yaml
indices_to_compare:
  - pool_name: "大概念股池"
    concept_name: "机器人概念"
    display_name: "机器人"  # 可选
    
  - pool_name: "大概念股池"
    concept_name: "AI概念"
    display_name: "AI"
```

- **pool_name**：股池名称（必须与`stock_pools.yaml`中一致）
- **concept_name**：概念名称（必须与`stock_pools.yaml`中一致）
- **display_name**：显示名称（可选，用于图表中显示的简短名称）

#### 3. 可视化配置

```yaml
visualization:
  title: "股池指数排名趋势"
  width: 1400
  height: 800
  show_markers: true
  line_width: 2
  show_grid: true
  output_filename: "index_ranking_comparison.html"
  output_dir: "reports"
```

- **title**：图表标题
- **width**：图表宽度（像素）
- **height**：图表高度（像素）
- **show_markers**：是否显示数据点标记
- **line_width**：线条宽度
- **show_grid**：是否显示网格
- **output_filename**：输出文件名
- **output_dir**：输出目录（相对于项目根目录）

### 完整配置示例

```yaml
# 比较起始日期
comparison_start_date: "2024-09-18"

# 需要比较的指数
indices_to_compare:
  - pool_name: "大概念股池"
    concept_name: "机器人概念"
    display_name: "机器人"
    
  - pool_name: "大概念股池"
    concept_name: "电池概念"
    display_name: "电池"
    
  - pool_name: "大概念股池"
    concept_name: "半导体概念"
    display_name: "半导体"
    
  - pool_name: "大概念股池"
    concept_name: "AI概念"
    display_name: "AI"
    
  - pool_name: "重点关注股池"
    concept_name: "新能源"
    display_name: "新能源"
    
  - pool_name: "重点关注股池"
    concept_name: "医药"
    display_name: "医药"
    
  - pool_name: "持仓股池"
    concept_name: "当前持仓"
    display_name: "当前持仓"

# 可视化配置
visualization:
  title: "股池指数排名趋势"
  width: 1400
  height: 800
  show_markers: true
  line_width: 2
  show_grid: true
  output_filename: "index_ranking_comparison.html"
  output_dir: "reports"
```

## 📊 输出说明

### 1. HTML可视化页面

**文件**：`reports/index_ranking_comparison.html`

**特点**：
- 交互式图表，可缩放、平移、显示详细数据
- Y轴反转，排名1显示在最上方
- 不同指数使用不同颜色区分
- 鼠标悬停显示日期、排名等信息
- 支持导出为PNG图片

**使用方法**：
- 双击浏览器打开HTML文件
- 使用鼠标拖动缩放图表
- 点击图例可隐藏/显示特定指数
- 点击右上角相机图标导出图片

### 2. CSV数据文件

**文件**：`reports/index_ranking_data.csv`

**内容**：
- `date`：交易日期
- `{指数名称}`：该指数的排名
- `{指数名称}_value`：该指数的归一化值
- `{指数名称}_pct`：该指数的涨跌幅（%）

**示例**：
```csv
date,机器人,AI,电池,机器人_value,AI_value,电池_value,机器人_pct,AI_pct,电池_pct
2024-09-18,2,1,3,100.00,100.00,100.00,0.00,0.00,0.00
2024-09-19,1,2,3,102.50,101.80,99.50,2.50,1.80,-0.50
...
```

## 💡 使用示例

### 示例1：比较大概念股池中的指数

**场景**：对比机器人、AI、电池、半导体四个概念的表现

**配置**：
```yaml
comparison_start_date: "2024-09-18"

indices_to_compare:
  - pool_name: "大概念股池"
    concept_name: "机器人概念"
    display_name: "机器人"
  - pool_name: "大概念股池"
    concept_name: "AI概念"
    display_name: "AI"
  - pool_name: "大概念股池"
    concept_name: "电池概念"
    display_name: "电池"
  - pool_name: "大概念股池"
    concept_name: "半导体概念"
    display_name: "半导体"
```

### 示例2：跨股池比较

**场景**：对比不同股池中的代表性概念

**配置**：
```yaml
comparison_start_date: "2024-09-18"

indices_to_compare:
  - pool_name: "大概念股池"
    concept_name: "AI概念"
    display_name: "AI"
  - pool_name: "重点关注股池"
    concept_name: "新能源"
    display_name: "新能源"
  - pool_name: "持仓股池"
    concept_name: "当前持仓"
    display_name: "当前持仓"
```

### 示例3：自定义可视化样式

**场景**：生成更大尺寸的图表用于演示

**配置**：
```yaml
visualization:
  title: "2024年Q4股池指数排名分析"
  width: 1920
  height: 1080
  show_markers: false  # 不显示数据点，线条更清晰
  line_width: 3
  show_grid: true
  output_filename: "q4_ranking_analysis.html"
```

## 🔧 程序化使用

### Python脚本示例

```python
from dwad.analysis.index_comparator import IndexComparator
from dwad.visualization.ranking_visualizer import RankingVisualizer

# 1. 创建比较器
comparator = IndexComparator()

# 2. 加载数据并计算排名
comparator.load_indices_data()
ranking_df = comparator.calculate_rankings()

# 3. 生成可视化
visualizer = RankingVisualizer()
ranking_data = comparator.get_ranking_data_for_visualization()
visualizer.generate_html(ranking_data)

# 4. 导出数据
comparator.export_ranking_to_csv("my_ranking.csv")
```

### 使用自定义配置文件

```python
from dwad.analysis.index_comparator import IndexComparator

# 指定配置文件路径
comparator = IndexComparator(
    comparison_config_path="config/my_comparison.yaml"
)

comparator.run()
```

## 🐛 常见问题

### Q1: 运行时提示"未找到指数数据"

**原因**：指定的股池或概念名称不存在，或指数未计算

**解决**：
1. 检查配置文件中的`pool_name`和`concept_name`是否正确
2. 确保已运行`calculate_index.py`计算指数
3. 检查`data/indices/`目录下是否存在对应的指数文件

### Q2: 排名趋势图显示异常

**原因**：比较起始日期设置不当，导致某些指数数据不足

**解决**：
1. 检查所有指数的起始日期
2. 将`comparison_start_date`设置为所有指数都有数据的日期
3. 或设置为`null`，让系统自动选择

### Q3: 如何添加或删除要比较的指数

**方法**：修改`config/index_comparison.yaml`中的`indices_to_compare`列表
- 添加：在列表中增加新的指数配置
- 删除：从列表中移除对应的指数配置

### Q4: 可视化页面打不开

**原因**：HTML文件生成失败或路径错误

**解决**：
1. 检查日志输出，查看是否有错误信息
2. 确认`reports`目录是否存在
3. 检查文件路径是否正确

### Q5: 如何理解排名数值

**说明**：
- 排名基于涨跌幅计算
- **排名1**：涨幅最大（表现最好）
- **排名越大**：涨幅越小或跌幅越大
- 排名会随着时间变化而变化

## 📈 高级用法

### 自定义排名计算逻辑

如需修改排名计算方式（如基于波动率、夏普比率等），可以修改`index_comparator.py`中的`calculate_rankings`方法。

### 批量生成报告

```python
from pathlib import Path
from dwad.analysis.index_comparator import IndexComparator
from dwad.visualization.ranking_visualizer import RankingVisualizer

configs = [
    "config/comparison_q1.yaml",
    "config/comparison_q2.yaml",
    "config/comparison_q3.yaml",
]

for config_path in configs:
    comparator = IndexComparator(config_path)
    comparator.run()
    
    visualizer = RankingVisualizer()
    data = comparator.get_ranking_data_for_visualization()
    
    output_name = Path(config_path).stem + "_ranking.html"
    visualizer.generate_html(data, f"reports/{output_name}")
```

## 📚 相关文档

- [开发计划](../开发计划.md)
- [股池指数验证报告](./股池指数验证报告.md)
- [指数计算异常处理说明](./指数计算异常处理说明.md)
- [配置示例文档](../examples/config_example.md)

## 🎉 总结

股池指数比较模块提供了完整的指数对比分析功能：
- ✅ 灵活的配置系统
- ✅ 智能的数据归一化和对齐
- ✅ 实时的排名计算
- ✅ 美观的可视化展示
- ✅ 便捷的数据导出

通过本模块，您可以轻松地对比分析多个股池指数的表现，发现强势概念，辅助投资决策。
