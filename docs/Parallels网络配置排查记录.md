# Parallels 虚拟机网络配置排查记录

> 记录时间：2024-12-10

## 问题现象

在 Mac 上运行的 Linux 容器（DWAD 项目）无法连接 Parallels Desktop 中 Windows 虚拟机上的掘金量化终端（GM3）API 服务，报错：

```text
{"status": 1001, "message": "无法连接到终端服务", "function": "history"}
{"status": 1001, "message": "无法连接到终端服务", "function": "current_price"}
{"status": 1001, "message": "无法连接到终端服务", "function": "get_symbols"}
```

## 环境信息

| 组件 | 配置 |
|------|------|
| 宿主机 | macOS，IP: 192.168.0.191 (en0) |
| 虚拟机软件 | Parallels Desktop |
| 虚拟机系统 | Windows 11 |
| 路由器 | 5G 随身 Wi-Fi，网关: 192.168.0.1 |
| 掘金终端 | GM3，监听端口: 7001 |

## 排查过程

### 1. 确认 GM3 服务状态

在 Windows 中执行 `netstat -ano | findstr 7001`，确认 GM3 已在 `0.0.0.0:7001` 监听：

```text
TCP    0.0.0.0:7001           0.0.0.0:0              LISTENING       8552
TCP    [::]:7001              [::]:0                 LISTENING       8552
```

**结论**：GM3 服务正常，且监听地址是 `0.0.0.0`（对外开放）。

### 2. 排除 Windows 防火墙

- 将 Windows Defender 防火墙的"域网络"、"专用网络"、"公用网络"全部关闭
- 从 Mac / 容器测试 `nc -vz 192.168.0.103 7001` 仍然超时

**结论**：不是 Windows 防火墙问题。

### 3. 测试网络连通性

| 测试路径 | 结果 |
|----------|------|
| Windows → 路由器 (192.168.0.1) | ✅ 通 |
| Mac → 路由器 (192.168.0.1) | ✅ 通 |
| Mac → Windows (192.168.0.103) | ❌ 不通 |
| Windows → Mac (192.168.0.191) | ❌ 不通 |

**结论**：Mac 和 Windows 都能访问路由器，但彼此之间无法通信。

### 4. 定位根因：5G 随身 Wi-Fi 的客户端隔离

5G 随身 Wi-Fi 设备通常默认启用"客户端隔离"（AP Isolation）功能，该功能会阻止同一 Wi-Fi 网络下的设备之间互相访问，只允许设备访问互联网。

特点：
- 很多随身 Wi-Fi 设备没有提供关闭此功能的选项
- 即使两台设备在同一网段（如 192.168.0.x），也无法互相 ping 通
- 这是一种安全特性，防止公共场合下的设备互相攻击

## 解决方案

### 将 Parallels 网络模式从"桥接"改为"共享网络"

**操作步骤**：

1. 打开 Parallels Desktop
2. 选择 Windows 虚拟机 → 点击齿轮图标（配置）
3. 进入 **硬件 → 网络**
4. 将"源"从"桥接网络: Wi-Fi"改为 **"共享网络 (Shared)"**
5. 重启 Windows 虚拟机

**改动后的网络拓扑**：

```
┌─────────────────────────────────────────────────────────────┐
│                        macOS 宿主机                          │
│                                                             │
│  ┌─────────────┐      ┌─────────────────────────────────┐  │
│  │ Linux 容器  │      │     Parallels 共享网络           │  │
│  │             │      │     (NAT: 10.211.55.0/24)       │  │
│  │             │◄────►│                                 │  │
│  └─────────────┘      │  ┌─────────────────────────┐   │  │
│                       │  │   Windows VM            │   │  │
│                       │  │   IP: 10.211.55.3       │   │  │
│                       │  │   GM3: 0.0.0.0:7001     │   │  │
│                       │  └─────────────────────────┘   │  │
│                       └─────────────────────────────────┘  │
│                                                             │
│  en0: 192.168.0.191 ──────► 5G 随身 Wi-Fi ──────► 互联网    │
└─────────────────────────────────────────────────────────────┘
```

**验证结果**：

```bash
# Windows 新 IP
IPv4 地址: 10.211.55.3

# Mac / 容器测试
$ nc -vz 10.211.55.3 7001
Connection to 10.211.55.3 7001 port [tcp/*] succeeded!
```

### 更新 DWAD 配置

修改 `config/config.yaml`：

```yaml
goldminer:
  token: "YOUR_TOKEN"
  serv_addr: "10.211.55.3:7001"  # 使用共享网络的 IP
```

## 两种网络模式对比

| 特性 | 桥接模式 (Bridged) | 共享网络 (Shared/NAT) |
|------|-------------------|----------------------|
| 虚拟机 IP | 与宿主机同网段 (192.168.0.x) | 独立网段 (10.211.55.x) |
| 依赖路由器 | 是 | 否 |
| 受 AP 隔离影响 | 是 | 否 |
| 外部设备可访问虚拟机 | 是 | 否（需端口转发） |
| 宿主机访问虚拟机 | 依赖路由器 | 始终可以 |
| 适用场景 | 虚拟机需要被局域网其他设备访问 | 虚拟机只需被宿主机访问 |

## 为什么桥接模式"突然"不行了？

用户反馈"6 小时前还能互联"，可能的原因：

### 1. 5G 随身 Wi-Fi 的动态行为

随身 Wi-Fi 设备可能在以下情况下改变行为：
- **重新连接移动网络**：设备重新拨号后，可能重置了内部配置
- **固件自动更新**：某些设备会静默更新，可能改变默认策略
- **连接设备数变化**：部分设备在检测到多个客户端时才启用隔离

### 2. DHCP 租约变化

- Mac 或 Windows 的 IP 地址可能因 DHCP 租约到期而变化
- 如果之前测试时两者恰好拿到了特殊的 IP 组合（如网关预留地址），可能绕过了隔离

### 3. 路由器缓存/状态

- 随身 Wi-Fi 通常资源有限，可能会定期清理 ARP 缓存或连接状态
- 清理后，客户端隔离策略可能被重新应用

### 4. 最可能的解释：VPN 网段冲突

**根因确认**：使用过 VPN，且 VPN 的虚拟网段恰好也是 `192.168.0.x`，与本地路由器的局域网网段冲突。

#### 为什么 VPN 会导致桥接失效？

1. **网段冲突**
   - 本地路由器网段：`192.168.0.0/24`
   - VPN 虚拟网段：`192.168.0.0/24`（相同！）
   - 当两个网段相同时，系统无法正确判断 `192.168.0.x` 的流量应该走本地网卡还是 VPN 隧道

2. **路由表被修改**
   - VPN 连接时会添加路由规则，把 `192.168.0.0/24` 的流量导向 VPN 隧道
   - VPN 断开后，路由表可能**没有完全恢复**，导致发给 `192.168.0.103`（Windows VM）的包走了错误的路径

3. **Parallels 桥接受影响**
   - Parallels 桥接模式依赖 Mac 的物理网卡（en0）和正确的路由
   - VPN 创建的虚拟网卡（utun*）和残留的路由规则会干扰桥接的正常工作

4. **ARP 缓存残留**
   - VPN 断开后，Mac 的 ARP 缓存可能还保留着 VPN 期间的错误映射
   - 导致 Mac 无法正确解析 `192.168.0.103` 的 MAC 地址

#### 恢复桥接模式的方法（如果需要）

```bash
# 方法 1：刷新网络接口
sudo ifconfig en0 down && sudo ifconfig en0 up

# 方法 2：清除 ARP 缓存
sudo arp -a -d

# 方法 3：最简单 - 关闭 Wi-Fi 再打开

# 方法 4：重启 Mac（最彻底）
```

然后重启 Parallels 虚拟机，再测试桥接。

#### 为什么"共享网络"模式不受影响？

共享网络使用独立的 NAT 网段（`10.211.55.0/24`），与 VPN 的 `192.168.0.0/24` 不冲突，所以不受 VPN 影响。这也是为什么改用共享网络后立刻就通了。

## 后续注意事项

1. **Windows VM 的 IP 可能变化**：共享网络模式下，Windows 的 IP 由 Parallels DHCP 分配，重启后可能变化。建议：
   - 在 Parallels 中为 Windows 设置静态 IP
   - 或每次启动后检查 `ipconfig` 并更新 `config.yaml`

2. **容器网络**：确保 Docker 容器能访问宿主机的 10.211.55.0/24 网段（默认情况下应该可以）

3. **备用方案**：如果共享网络也出问题，可以尝试：
   - Mac 开热点，让 Windows 连接
   - 使用支持关闭 AP 隔离的路由器
