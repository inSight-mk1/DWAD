# 股池提取脚本使用说明

本文档介绍如何使用 THS（同花顺）和中证指数股池提取脚本，将 Excel 文件中的股池数据提取并合并到 YAML 配置文件中。

## 脚本概览

| 脚本文件 | 功能 | 数据源 | 输出格式 |
|---------|------|--------|----------|
| `scripts/extract_csi_index_pools.py` | 提取中证指数股池 | `pool_xls/zzzs/*.xls(x)` | YAML 配置文件 |
| `scripts/extract_ths_index_pools.py` | 提取同花顺板块股池 | `pool_xls/ths/*.xls(x)` | YAML 配置文件 |

---

## 1. 中证指数股池提取脚本

### 脚本路径
```
scripts/extract_csi_index_pools.py
```

### 功能说明
- 从 `pool_xls/zzzs/` 目录中的 Excel 文件提取中证指数成分股
- 支持 **覆盖模式** 和 **追加模式** 两种写入方式
- 自动识别指数名称和成分券名称

### 数据源要求
Excel 文件必须包含以下列：
- `指数名称 Index Name`：指数的完整名称
- `成份券名称Constituent Name`：成分股的中文名称

### 使用方法

#### 基本用法（覆盖模式）
```bash
# 提取 pool_xls/zzzs 目录下的所有指数，覆盖写入到独立文件
python scripts/extract_csi_index_pools.py
```
- **输出文件**：`config/stock_pools_csi_indices.yaml`
- **模式**：覆盖模式，会创建新的独立配置文件

#### 追加模式
```bash
# 将提取的指数追加到主配置文件
python scripts/extract_csi_index_pools.py --append
```
- **输出文件**：`config/stock_pools.yaml`
- **模式**：追加模式，会合并到现有配置文件

#### 指定数据源目录
```bash
# 从自定义目录提取指数数据
python scripts/extract_csi_index_pools.py --source custom_dir --append
```

### 命令行参数

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `--source` | string | `zzzs` | 指数数据源目录名（位于 pool_xls 下） |
| `--append` | flag | False | 追加模式：追加到 stock_pools.yaml，否则覆盖写入独立文件 |

### 输出示例
```yaml
# 中证指数股池配置文件
# 此文件由 extract_csi_index_pools.py 自动生成
# 数据来源: pool_xls/zzzs 目录
# 包含 15 个中证指数

stock_pools:
  大概念股池:
    中证500:
      - 五粮液
      - 招商银行
      - 中国平安
      # ... 更多成分股
    沪深300:
      - 贵州茅台
      - 腾讯控股
      - 阿里巴巴
      # ... 更多成分股
```

---

## 2. 同花顺板块股池提取脚本

### 脚本路径
```
scripts/extract_ths_index_pools.py
```

### 功能说明
- 从 `pool_xls/ths/` 目录中的 Excel 文件提取同花顺板块成分股
- **仅支持追加模式**，会自动合并到主配置文件
- 使用文件名作为板块名称

### 数据源要求
Excel 文件格式：
- 文件名即为板块名称（不含扩展名）
- 文件内容为制表符分隔的文本格式（.xls）
- 必须包含股票名称列，支持多种列名：
  - `名称`、`股票名称`、`证券名称`、`成份券名称`
  - `name`、`Name`、`STOCK_NAME`

### 使用方法

#### 基本用法
```bash
# 提取 pool_xls/ths 目录下的所有板块，追加到主配置文件
python scripts/extract_ths_index_pools.py
```

#### 指定自定义目录
```bash
# 从自定义目录提取板块数据
python scripts/extract_ths_index_pools.py --xls_dir pool_xls/ths_25121701
```

#### 指定输出文件
```bash
# 指定输出到自定义配置文件
python scripts/extract_ths_index_pools.py --output_file /path/to/custom_pools.yaml
```

### 命令行参数

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `--xls_dir` | string | `pool_xls/ths` | 包含同花顺 XLS 文件的目录路径 |
| `--output_file` | string | `config/stock_pools.yaml` | 输出的 YAML 配置文件路径 |

### 输出示例
```yaml
# 中证指数股池配置文件
# 此文件由 extract_csi_index_pools.py 和 extract_ths_index_pools.py 自动生成和更新
# 数据来源: pool_xls/zzzs 和 pool_xls/ths 目录
# 包含 25 个指数/板块

stock_pools:
  大概念股池:
    # 中证指数
    中证500:
      - 五粮液
      - 招商银行
    # 同花顺板块
    新能源汽车:
      - 比亚迪
      - 宁德时代
    人工智能:
      - 科大讯飞
      - 海康威视
```

---

## 3. 合并股池的完整流程

### 推荐工作流程

1. **首次设置**：使用中证指数脚本创建基础配置
```bash
python scripts/extract_csi_index_pools.py --append
```

2. **追加同花顺板块**：将 THS 板块数据合并到同一配置文件
```bash
python scripts/extract_ths_index_pools.py
```

3. **更新数据**：当有新的 Excel 文件时，重复步骤 1-2

### 目录结构要求
```
DWAD/
├── pool_xls/
│   ├── zzzs/          # 中证指数 Excel 文件
│   │   ├── 中证500.xls
│   │   ├── 沪深300.xlsx
│   │   └── ...
│   └── ths/           # 同花顺板块 Excel 文件
│       ├── 新能源汽车.xls
│       ├── 人工智能.xls
│       └── ...
├── config/
│   └── stock_pools.yaml    # 合并后的股池配置文件
└── scripts/
    ├── extract_csi_index_pools.py
    └── extract_ths_index_pools.py
```

---

## 4. 注意事项

### 数据格式要求
- **中证指数**：Excel 文件必须包含标准的指数名称和成分券名称列
- **同花顺板块**：文件名即板块名，内容为制表符分隔格式，编码为 GBK

### 重复处理
- 两个脚本都会检测重复的指数/板块名称
- 如果发现重复，会更新成分股列表并给出警告

### 错误处理
- 脚本会自动跳过无法解析的文件
- 详细的错误日志会显示在控制台
- 如果某个文件解析失败，不会影响其他文件的处理

### 输出文件说明
- 所有指数和板块都归类到 `大概念股池` 类别下
- 系统会自动将中文股票名称转换为掘金 API 所需的股票代码格式
- YAML 文件包含详细的注释和统计信息

---

## 5. 故障排除

### 常见问题

**Q: 脚本提示"文件缺少必需列"**
- 检查 Excel 文件是否包含正确的列名
- 对于中证指数，确保有 `指数名称 Index Name` 和 `成份券名称Constituent Name` 列

**Q: 同花顺文件解析失败**
- 确认文件编码为 GBK
- 检查文件是否为制表符分隔格式
- 确保文件包含股票名称相关的列

**Q: 追加模式失败**
- 确保目标 YAML 文件存在且格式正确
- 检查文件权限是否允许写入

### 调试技巧
- 使用 `--help` 查看完整的命令行参数说明
- 查看控制台输出的详细日志信息
- 检查生成的 YAML 文件格式是否正确
